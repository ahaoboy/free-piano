import{jsxs as g,jsx as c}from"https://esm.sh/react/jsx-runtime";import{createRoot as ue}from"https://esm.sh/react-dom/client";import Ne,{useState as f,useEffect as z,useRef as D}from"https://esm.sh/react";import{Typography as x,Flex as d,theme as be,ConfigProvider as Fe,Select as ie,Switch as T,AutoComplete as Ae,Upload as Se,Button as K,Slider as xe,Tabs as Be,unstableSetRender as De}from"https://esm.sh/antd?standalone";import Ee from"https://esm.sh/fuse.js?standalone";import{decode as Oe}from"https://esm.sh/free-piano-midi?standalone";import{GithubOutlined as Le,SunOutlined as Ge,MoonOutlined as Me,UploadOutlined as Te,PauseOutlined as Ke,PlayCircleOutlined as Pe,RedoOutlined as je}from"https://esm.sh/@ant-design/icons?standalone";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const Ie={A0:"-",B0:"=",C1:"[",D1:"]",E1:"\\",F1:";",G1:"'",A1:",",B1:".",C2:"1",D2:"2",E2:"3",F2:"4",G2:"5",A2:"6",B2:"7",C3:"8",D3:"9",E3:"0",F3:"q",G3:"w",A3:"e",B3:"r",C4:"t",D4:"y",E4:"u",F4:"i",G4:"o",A4:"p",B4:"a",C5:"s",D5:"d",E5:"f",F5:"g",G5:"h",A5:"j",B5:"k",C6:"l",D6:"z",E6:"x",F6:"c",G6:"v",A6:"b",B6:"n",C7:"m",D7:"1",E7:"2",F7:"3",G7:"4",A7:"5",B7:"6",C8:"7","A#0":"_","C#1":"{","D#1":"}","F#1":":","G#1":'"',"A#1":"<","C#2":"!","D#2":"@","F#2":"$","G#2":"%","A#2":"^","C#3":"*","D#3":"(","F#3":"Q","G#3":"W","A#3":"E","C#4":"T","D#4":"Y","F#4":"I","G#4":"O","A#4":"P","C#5":"S","D#5":"D","F#5":"G","G#5":"H","A#5":"J","C#6":"L","D#6":"Z","F#6":"C","G#6":"V","A#6":"B","C#7":"1","D#7":"2","F#7":"3","G#7":"4","A#7":"5"};function j(e){const t=de(e);return Ie[t]}function H(e){for(const t of B)if(j(t.midi)===e)return t.midi;return 0}function ae(e){return H(e.key)}function de(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=e%12,o=Math.floor(e/12)-1;return`${t[n]}${o}`}const Re=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function J(e){const t=e%12;return Re[t].includes("#")}const B=Array(88).fill(0).map((e,t)=>{const n=t+21,o=de(n);return{midi:n,name:o,isBlack:J(n)}});function fe(e){return`calc(100% / ${V(e).length})`}function me(e){switch(e){case"Full":return B;case"Small":{const t=B.findIndex(o=>o.name==="C2"),n=B.findIndex(o=>o.name==="C7");return B.slice(t,n+1)}}}function V(e){return me(e).filter(t=>!t.isBlack)}function he(e){return me(e).filter(t=>t.isBlack)}function pe(e,t){switch(t){case"Full":{if(e===0)return .5;let n=2.5;const o=(e-1)/5|0;n+=o*7;const r=e%5;return n+=[5,0,1,3,4][r],n}case"Small":{let n=.5;const o=e/5|0;n+=o*7;const r=e%5;return n+=[5,0,1,3,4][r],n}}}const $e="/free-piano",Ue={Full:"piano-full",Small:"piano"};function ye(e,t){return`${$e}/${Ue[t]}/${e}.mp3`}const _e=e=>{const t=new Audio(e),n=()=>{t.removeEventListener("ended",n),t.removeEventListener("error",n),t.src=""};t.addEventListener("ended",n),t.addEventListener("error",n),t.play().catch(o=>{n(),console.error("Audio playback failed",o)})};function P(e,t){const n=ye(e,t);_e(n)}function We(e,t){const n=ye(e,t),o=new Audio(n),r=()=>{o.removeEventListener("canplaythrough",r),o.removeEventListener("error",r),o.src=""};o.addEventListener("canplaythrough",r),o.addEventListener("error",r),o.load()}const{Title:S}=x,Ye=({showNote:e,showKey:t,showSolfa:n,mute:o,audioStyle:r,layout:i,textLevel:a})=>{const[u,h]=f(new Set),w=l=>{u.has(l)||(h(y=>new Set([...y,l])),P(l,r))},p=l=>{h(y=>{const C=new Set(y);return C.delete(l),C})};z(()=>{const l=C=>{if(o)return;const v=ae(C);v&&(h(N=>new Set([...N,v])),w(v))},y=C=>{if(o)return;const v=ae(C);v&&p(v)};return document.addEventListener("keydown",l),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",l),document.removeEventListener("keyup",y)}});const E=V(i),b=fe(i),I=he(i);return g(d,{className:"piano-container",children:[c(d,{className:"white-keys",children:E.map((l,y)=>g(d,{className:"piano-key white-key"+(u.has(l.midi)?" press-key":""),onClick:()=>{P(l.midi,r)},vertical:!0,style:{width:b},children:[n&&c(S,{children:["do","re","mi","fa","so","la","si"][y%5]}),e&&c(S,{className:"key-text",level:a,children:l.name}),t&&c(S,{className:"key-text",level:a,children:j(l.midi)})]},l.midi))}),c(d,{className:"black-keys",children:I.map((l,y)=>g(d,{className:`piano-key black-key BlackIndex_${y} `+(u.has(l.midi)?" press-key":""),onClick:()=>{P(l.midi,r)},vertical:!0,style:{width:b,transform:`translateX(calc(${pe(y,i)} * 100%))`},align:"center",children:[e&&c(S,{className:"key-text",level:a,children:l.name}),t&&c(S,{className:"key-text",level:a,children:j(l.midi)})]},l.midi))})]})};function Xe(){return fetch("https://raw.githubusercontent.com/ahaoboy/free-piano-cdn/main/assets/urls.json").then(e=>e.json())}function qe(e){return fetch(`https://raw.githubusercontent.com/ahaoboy/free-piano-cdn/main/assets/pages/${e}.html`).then(t=>t.text())}function ze(e,t){const n=V(t),o=he(t);if(J(e.code)){const r=o.findIndex(a=>a.midi===e.code);return pe(r,t)}else return n.findIndex(i=>i.midi===e.code)}function He(e,t,n,o){return`translateY(calc(${(1-(e.start-t)/n)*100*100/o}%))`}function Je({note:e,now:t,duration:n,layout:o}){const r=ze(e,o),i=He(e,t,n,2),a=["note-item"];J(e.code)?a.push("note-black"):a.push("note-white");const u=fe(o);return c(d,{className:a.join(" "),style:{width:u,height:"2%",transform:`translateX(calc(${r*100}%)) ${i}`},children:j(e.code)})}function Ve(e,t,n){return e.start>=t&&e.end<=t+n}const Qe=({notes:e,now:t,duration:n,autoplay:o,audioStyle:r,layout:i,mute:a})=>{const u=D([]),h=e.filter(p=>Ve(p,t,n)),w=D([]);if(w.current!==e&&(w.current=e,u.current=[]),a&&(u.current=[]),o&&!a){for(const p of u.current)h.includes(p)||P(p.code,r);u.current=h}return c(d,{className:"rain-main",children:h.map(p=>c(Je,{layout:i,note:p,now:t,duration:n},JSON.stringify(p)))})};function q(e){const t={};let n=60;for(const u of"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@$%^*(")t[u]=n++;const o=[];let r=0;const i=.5;let a=0;for(;a<e.length;){const u=e[a];if(u===" "||u===`
`){a++;continue}else if(u==="["){const h=e.indexOf("]",a+1);if(h===-1)throw new Error("Missing closing bracket ]");const w=e.slice(a+1,h);for(const p of w)p in t&&o.push({code:H(u),start:r,end:r+i,free:()=>{}});a=h+1,r+=i}else u in t?(o.push({code:H(u),start:r,end:r+i,free:()=>{}}),a++,r+=i):a++}return o}function Ze(e,t,n){return Math.min(Math.max(e,t),n)}const{defaultAlgorithm:et,darkAlgorithm:tt}=be,le=15;function nt(){const[e,t]=f(!0),[n,o]=f(!1),[r,i]=f(!1),[a,u]=f(!1),[h,w]=Ne.useState([]),[p,E]=f([]),b=D(null),[I,l]=f(""),[y,C]=f(""),[v,N]=f(!1),[O,L]=f([]),[Q,G]=f(0),[Z,ee]=f(globalThis.matchMedia("(prefers-color-scheme: dark)").matches),[R,$]=f(0),[U,te]=f("Full"),[_,rt]=f("Full"),[ge,ne]=f("Text"),W=O.at(-1)?.end||0,re=Ze(Q/W*100|0,0,100),[oe,Ce]=f(3);z(()=>{const s=new Set(O.map(m=>m.code));for(const m of s)We(m,_)},[O]),z(()=>{Xe().then(s=>{E(s),b.current=new Ee(s,{keys:["title"]})})},[]);function ve(s){return b.current?.search(s).slice(0,10).map(m=>({label:m.item.title,value:m.item.id.toString()}))||[]}function we(){$(+setInterval(()=>G(s=>s+1/le),1e3/le))}function se(){clearInterval(R),$(0)}function ke(){clearInterval(R),$(0),G(0)}const ce=D(!1),Y=D(!1);return c(Fe,{theme:{algorithm:Z?tt:et},children:g(d,{className:"App",vertical:!0,children:[g(d,{className:"header",vertical:!0,justify:"center",align:"center",gap:"small",children:[g(d,{justify:"center",align:"center",gap:"small",children:[g(d,{gap:"middle",justify:"center",align:"center",style:{position:"absolute",top:"1rem",right:"1rem"},children:[c(x.Link,{href:"https://github.com/ahaoboy/free-piano",target:"_blank",children:c(Le,{})}),Z?c(x.Link,{onClick:()=>ee(!1),children:c(Ge,{})}):c(x.Link,{onClick:()=>ee(!0),children:c(Me,{})})]}),"textsize:",c(ie,{value:oe,style:{width:50},onChange:s=>{Ce(s)},options:Array(5).fill(0).map((s,m)=>({value:m+1,label:m+1}))}),"layout:",c(ie,{value:U,style:{width:80},onChange:s=>{te(s)},options:[{value:"Full",label:"Full"},{value:"Small",label:"Small"}]}),g(d,{justify:"center",align:"center",gap:"small",children:["key:",c(T,{value:e,onChange:s=>{t(s)}})]}),g(d,{justify:"center",align:"center",gap:"small",children:["note:",c(T,{value:n,onChange:s=>{o(s)}})]}),g(d,{justify:"center",align:"center",gap:"small",children:["solfa(C major):",c(T,{value:r,onChange:s=>{i(s)}})]}),g(d,{justify:"center",align:"center",gap:"small",children:["autoplay:",c(T,{value:a,onChange:s=>{u(s)}})]})]}),g(d,{className:"control-main",children:[c(Ae,{value:I,options:h,style:{width:200},onSearch:s=>w(ve(s)),placeholder:"input here",onSelect:async s=>{const m=await qe(s),A=new DOMParser().parseFromString(m,"text/html").body.textContent||"";C(A);const M=p.find(X=>X.id===+s);l(M?.title||""),L(q(A))},onChange:s=>{l(s)},onBlur:()=>{N(!1)},onFocus:()=>{N(!0)}}),c(Se,{name:"file",action:"*",customRequest:s=>s.onSuccess?.(!0),showUploadList:!1,onChange:async s=>{if(s.file.status==="done")return;se();const m=s.file.name.split(".").at(-1)?.toLowerCase()||"";if(["txt"].includes(m)){const k=await s.file.originFileObj?.text()||"";C(k);const F=q(k);L(F);return}if("html".includes(m)){const k=await s.file.originFileObj?.text()||"",M=new DOMParser().parseFromString(k,"text/html").body.textContent||"";C(M);const X=q(M);L(X);return}if(["mid","midi"].includes(m)){E([]);const k=s.file.originFileObj;if(!k)return;const F=new Uint8Array(await k.arrayBuffer()),A=await Oe(F);L(A||[]),te("Full"),ne("Midi")}},children:c(K,{icon:c(Te,{}),children:"Upload"})}),R?c(K,{icon:c(Ke,{}),onClick:se,children:"Pause"}):c(K,{icon:c(Pe,{}),onClick:we,children:"Play"}),c(K,{icon:c(je,{}),onClick:ke,children:"Replay"}),g(d,{className:"app-progress",justify:"center",align:"center",children:[c(xe,{className:"progress-bar",value:re,onChange:s=>{N(!0),G(W*s/100),Y.current||(ce.current=v),Y.current=!0},onChangeComplete:s=>{G(W*s/100),N(ce.current),Y.current=!1}}),re,"%"]})]})]}),c(Be,{activeKey:ge,onChange:s=>{ne(s)},centered:!0,items:[{key:"Text",label:"Text",children:c(d,{className:"score-main",children:c(x.Title,{children:y})})},{key:"Midi",label:"Midi",children:c(d,{className:"app-rain",children:c(Qe,{audioStyle:_,layout:U,notes:O,now:Q,duration:10,autoplay:a,mute:v})})}],className:"app-tab"}),c(d,{className:"app-piano",children:c(Ye,{audioStyle:_,layout:U,mute:v,showNote:n,showKey:e,showSolfa:r,textLevel:oe})})]})})}De(function(e,t){t._reactRoot||(t._reactRoot=ue(t));var n=t._reactRoot;return n.render(e),function(){return new Promise(function(o){setTimeout(function(){n.unmount(),o()},0)})}});ue(document.getElementById("root")).render(c(nt,{}));
